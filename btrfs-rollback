#!/bin/bash

#Global Variables

BTRFS_MOUNT=/root/toplevel

#Functions

rollback() {
    local PROFILE="$1"
    local HOME_FOLDER=/home/"$PROFILE"
    local LATEST

    if dirs=("$BTRFS_MOUNT"/@snapshots/"$PROFILE"/*/) && [[ -d ${dirs[0]} ]]; then
        LATEST=$(stat -c '%y %n' "$BTRFS_MOUNT"/@snapshots/"$1"/* | sort -n -r | head -n 1 | cut -f 4 -d " ")
        printf 'Snapshots exist for %s.\nBeginning rollback to latest snapshot at %s\n' "$PROFILE" "$LATEST"
        umount "$HOME_FOLDER"
        btrfs subvolume delete -c "$BTRFS_MOUNT"/@"$PROFILE"
        btrfs subvolume snapshot "$LATEST" "$BTRFS_MOUNT"/@"$PROFILE"
        mount "$HOME_FOLDER"
    else
        echo "No snapshots exist for '$PROFILE'"
        exit 2
    fi
}

#Determine which function the user passed in to the command

case "$1" in
"") ;;
rollback)
    "$@"
    exit
    ;;
*)
    echo "Unknown function: $1"
    exit 2
    ;;
esac
